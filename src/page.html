<!DOCTYPE html>
<html>
    <head>
        <title>Canvas Test</title>
    </head>
    <body >
        <script>
        var canvas = document.createElement('canvas');
        document.body.appendChild(canvas);
        document.addEventListener('contextmenu', event => event.preventDefault());
        const socket = new WebSocket('ws://'+window.location.hostname+":8080");

        document.body.style.margin = 0;
        var ctx = canvas.getContext('2d');
        var pos = { x: 0, y: 0 };
        var button = 0;

        canvas.oncontextmenu = function (e) {
            e.preventDefault();
        };

        resize();

        // Mapping of JavaScript keydown event codes to uinput keycodes (QWERTY layout)
        const keyCodeMap = {
            "Enter": 28,
            "Escape": 1,
            "ArrowUp": 103,
            "ArrowDown": 108,
            "ArrowLeft": 105,
            "ArrowRight": 106,
            "Backspace": 14,
            "Tab": 15,
            "Space": 57,
            "KeyA": 30,
            "KeyB": 48,
            "KeyC": 46,
            "KeyD": 32,
            "KeyE": 18,
            "KeyF": 33,
            "KeyG": 34,
            "KeyH": 35,
            "KeyI": 23,
            "KeyJ": 36,
            "KeyK": 37,
            "KeyL": 38,
            "KeyM": 50,
            "KeyN": 49,
            "KeyO": 24,
            "KeyP": 25,
            "KeyQ": 16,
            "KeyR": 19,
            "KeyS": 31,
            "KeyT": 20,
            "KeyU": 22,
            "KeyV": 47,
            "KeyW": 17,
            "KeyX": 45,
            "KeyY": 21,
            "KeyZ": 44,
            "Digit0": 11,
            "Digit1": 2,
            "Digit2": 3,
            "Digit3": 4,
            "Digit4": 5,
            "Digit5": 6,
            "Digit6": 7,
            "Digit7": 8,
            "Digit8": 9,
            "Digit9": 10,
            "ShiftLeft": 42,
            "ShiftRight": 54,
            "ControlLeft": 29,
            "ControlRight": 97,
            "AltLeft": 56,
            "AltRight": 100,
            "MetaLeft": 125,
            "MetaRight": 126,
            "ContextMenu": 101,
            "CapsLock": 58,
            "ScrollLock": 70,
            "NumLock": 69,
            "PrintScreen": 99,
            "Insert": 110,
            "Home": 102,
            "End": 107,
            "PageUp": 104,
            "PageDown": 109,
            "F1": 59,
            "F2": 60,
            "F3": 61,
            "F4": 62,
            "F5": 63,
            "F6": 64,
            "F7": 65,
            "F8": 66,
            "F9": 67,
            "F10": 68,
            "F11": 87,
            "F12": 88,
            "AltGr": 100,
            "BracketLeft": 26,
            "BracketRight": 27,
            "Backslash": 43,
            "Semicolon": 39,
            "Quote": 40,
            "Comma": 51,
            "Period": 52,
            "Slash": 53,
            "Minus": 12,
            "Equal": 13,
            "Backquote": 41
        };

        // Function to convert JavaScript keydown event code to uinput keycode
        function convertKeyCode(jsKeyCode) {
            return keyCodeMap[jsKeyCode] || null; // Return the uinput keycode or null if not found
        }


        window.addEventListener('resize', resize);
        document.addEventListener('mousemove', on_move);
        document.addEventListener('mousedown', on_press);
        document.addEventListener('mouseup', on_release);
        document.addEventListener('mouseenter', on_move);

        // Touch event listeners
        document.addEventListener('keydown', on_key_press);
        document.addEventListener('keyup', on_key_release);
        document.addEventListener('touchstart', on_press);
        document.addEventListener('touchmove', on_move);
        document.addEventListener('touchend', on_release);

        // Handle key press events
        function on_key_press(e) {
            e.preventDefault();
            console.log(convertKeyCode(e.code));
            var tbody = "type:\tEV_KEY\n";
            tbody += "code:\t" + convertKeyCode(e.code) + "\n"; // Use the key code
            tbody += "value:\t1\n\0"; // Key down
            socket.send(tbody);
        }

        // Handle key release events
        function on_key_release(e) {
            e.preventDefault();
            var tbody = "type:\tEV_KEY\n";
            tbody += "code:\t" + convertKeyCode(e.code) + "\n"; // Use the key code
            tbody += "value:\t0\n\0"; // Key up
            socket.send(tbody);
        }

        function on_press(e) {
            console.log(e.key);
            e.preventDefault();
            var tbody = "type:\tEV_KEY\n";
            if (e.touches) {
                tbody += "code:\tBTN_TOUCH\n";
                button = 330;
            } else {
                button = e.buttons;
                if (e.buttons == 1){
                    tbody += "code:\tBTN_LEFT\n";
                } else if (e.buttons == 2) {
                    tbody += "code:\tBTN_RIGHT\n";
                }
            }
            tbody += "value:\t1\n\0";
            socket.send(tbody)
        }

        function on_release(e) {
            e.preventDefault();
            var tbody = "type:\tEV_KEY\n";
            if (button == 1){
                tbody += "code:\tBTN_LEFT\n";
            } else if (button == 2) {
                tbody += "code:\tBTN_RIGHT\n";
            } else if (button == 330) {
                tbody += "code:\tBTN_TOUCH\n";
            }
            button = 0;
            tbody += "value:\t0\n\0";
            socket.send(tbody)
        }

        // new position from mouse/touch event
        function on_move(e) {
            e.preventDefault();
            if (e.touches) {
                pos.x = e.touches[0].clientX;
                pos.y = e.touches[0].clientY;
            } else {
                pos.x = e.clientX;
                pos.y = e.clientY;
            }
            pos.x = (pos.x * 1920) / ctx.canvas.width;
            pos.y = (pos.y * 1080) / ctx.canvas.height;
            var tbody = "type:\tEV_ABS\n";
            tbody += "code:\tABS_X\n";
            tbody += "value:\t"+pos.x+"\n\0";
            socket.send(tbody);
            tbody = "type:\tEV_ABS\n";
            tbody += "code:\tABS_Y\n";
            tbody += "value:\t"+pos.y+"\n\0";
            socket.send(tbody);
        }

        // resize canvas
        function resize() {
            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
        }

        </script>
    </body>
</html>

